# format string 0

## Method

```
Can you use your knowledge of format strings to make the customers happy?
Download the binary here.
Download the source here.
Connect with the challenge instance here:
nc mimas.picoctf.net 53238
```

```c
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <signal.h>
#include <unistd.h>
#include <sys/types.h>

#define BUFSIZE 32
#define FLAGSIZE 64

char flag[FLAGSIZE];

void sigsegv_handler(int sig) {
    printf("\n%s\n", flag);
    fflush(stdout);
    exit(1);
}

int on_menu(char *burger, char *menu[], int count) {
    for (int i = 0; i < count; i++) {
        if (strcmp(burger, menu[i]) == 0)
            return 1;
    }
    return 0;
}

void serve_patrick();

void serve_bob();


int main(int argc, char **argv){
    FILE *f = fopen("flag.txt", "r");
    if (f == NULL) {
        printf("%s %s", "Please create 'flag.txt' in this directory with your",
                        "own debugging flag.\n");
        exit(0);
    }

    fgets(flag, FLAGSIZE, f);
    signal(SIGSEGV, sigsegv_handler);

    gid_t gid = getegid();
    setresgid(gid, gid, gid);

    serve_patrick();
  
    return 0;
}

void serve_patrick() {
    printf("%s %s\n%s\n%s %s\n%s",
            "Welcome to our newly-opened burger place Pico 'n Patty!",
            "Can you help the picky customers find their favorite burger?",
            "Here comes the first customer Patrick who wants a giant bite.",
            "Please choose from the following burgers:",
            "Breakf@st_Burger, Gr%114d_Cheese, Bac0n_D3luxe",
            "Enter your recommendation: ");
    fflush(stdout);

    char choice1[BUFSIZE];
    scanf("%s", choice1);
    char *menu1[3] = {"Breakf@st_Burger", "Gr%114d_Cheese", "Bac0n_D3luxe"};
    if (!on_menu(choice1, menu1, 3)) {
        printf("%s", "There is no such burger yet!\n");
        fflush(stdout);
    } else {
        int count = printf(choice1);
        if (count > 2 * BUFSIZE) {
            serve_bob();
        } else {
            printf("%s\n%s\n",
                    "Patrick is still hungry!",
                    "Try to serve him something of larger size!");
            fflush(stdout);
        }
    }
}

void serve_bob() {
    printf("\n%s %s\n%s %s\n%s %s\n%s",
            "Good job! Patrick is happy!",
            "Now can you serve the second customer?",
            "Sponge Bob wants something outrageous that would break the shop",
            "(better be served quick before the shop owner kicks you out!)",
            "Please choose from the following burgers:",
            "Pe%to_Portobello, $outhwest_Burger, Cla%sic_Che%s%steak",
            "Enter your recommendation: ");
    fflush(stdout);

    char choice2[BUFSIZE];
    scanf("%s", choice2);
    char *menu2[3] = {"Pe%to_Portobello", "$outhwest_Burger", "Cla%sic_Che%s%steak"};
    if (!on_menu(choice2, menu2, 3)) {
        printf("%s", "There is no such burger yet!\n");
        fflush(stdout);
    } else {
        printf(choice2);
        fflush(stdout);
    }
}
```
At first glance the c code looks overwhelming...loads of stuff i havent seen before and some familiar.

First let me try running it

```
tempCodeRunnerFile.c:1:1: error: expected '=', ',', ';', 'asm' or '__attribute__' at end of input
 gid_t
 ^~~~~
```
We seem to face this error So let us try examining the code first.

Looking at our functions we first identifie that there is a segmentation fault handler i.e ``sigsegv_handler`` where if there is a segmentation fault it prints the flag then exits the programme.

We also have an on the menu function that checks for the user inputted burger name checking if its on the menu.

It seems main opens flag.txt to read a debugging flag. It then seems to read upto 64 characters of the flag size I.E the global variable
``FLAGSIZE`` into the global flag array.  ``signal(SIGSEGV, sigsegv_handler);`` This then setups the handler for segmentation faults.


I then start to see the use of new c headers such as ``<sys/types.h>`` This essentially allows us to use the ``gid_t``, ``uid_t``, ``pid_t`` enabling the use of group ids. *gid_t* which is used in this programme are similar to linux systems. It is a a data type used to store group IDs in a programme. In linux a group ID is a value assigned to a group of users in a linux system. Used to control permissions of files and resources (callback to pwncollege stuff). Now essentially what it does is create a variable gid and has taken the value of the effective group id of the running process. It essentially dictates the group permission my programme is using. We then see the use of a function ``setresgid(gid, gid, gid)`` This essentially sets the ``real``, ``effective`` and ``saved`` group ids. By doing this it ensures the rest of the programme has the same permissions. it ensures that it keeps this permission throughout the programmes execution making it so that it does not run into fault.

We then see a function called ``serve_patrick`` this first has its own menu I.E *menu1* with some weird names with ``"Gr%114d_Cheese"`` standing out. We know this as % is a format specifier and using this in a string will cause some sort of error. We then take an input of string into the variable choice1 (*Note:* we had set this to 32 space). From here it uses the ``on_menu`` function and checks on the user's input, if the choice is not there it prints an error message else it proceeds to check the size of the choice  by first returning the number of characters printed into ``count``. it then proceeds to check if count is greater than 2 * BUFSIZE which was set to 32 so essentially checking if greater than 64. If greater then we serve bob otherwise patrick will still be hungry.

Lastly moving on  to the ``serve_bob`` we  also have our own menu with some weird names being ``Pe%to_Portobello`` and ``Cla%sic_Che%s%steak`` We then declare choice2 with 32 space and take the users input here. we then proceed to do a similar on_menu if there then continue else it does'nt exist on menu and we exit. If found it prints the burgers name.


### Solution

Now when it comes to getting the flag from this programme we cannot really see a way to have an error except through going through bob's programme as we see a line ``printf(choice2);`` from my psuc knowlege this screams out to me as an error as when printing a variable of any type we must use an identifier such as **%s** to print the string Meaning we must be able to serve bob by giving patrick an item that is of 64 bytes. Normally we need to use a format specifier for the printf statement however in this case it can cause issues if there where format specificers in the input. 


Now when it comes to passing one of the items that exceeds 64 items of the 3 menu items luckily ``"Gr%114d_Cheese"`` satisfies this condition. this is due to the **%114d** This is a format specifier for a width of 114d characters. As this has no value provided as it should be used in print statements. It fills this with garbage values allowing us to reach our 114d characters.

This allows us to enter the bob one where we just need to cause a Seg fault to get the flag. Like before we can possibly enter ``Pe%to_Portobello`` However this will not return the flag as **%t** is not a valid format specifier. Looking at ``Cla%sic_Che%s%steak`` we can see the use of multiple **%s** which expects a string argument and **%steak** is not a valid format. Now a cool thing about %s when theres no string argument provided it starts accessing the memory that may cause the programme to crash and to our suprise it does returning the flag.

I just realised that i could have very well just overloaded a character to cause a segmentation fault taking us to the flag as well.


``` 
Welcome to our newly-opened burger place Pico 'n Patty! Can you help the picky customers find their favorite burger?
Here comes the first customer Patrick who wants a giant bite.
Please choose from the following burgers: Breakf@st_Burger, Gr%114d_Cheese, Bac0n_D3luxe
Enter your recommendation: Gr%114d_Cheese
Gr                                                                                                           4202954_Cheese
Good job! Patrick is happy! Now can you serve the second customer?
Sponge Bob wants something outrageous that would break the shop (better be served quick before the shop owner kicks you out!)
Please choose from the following burgers: Pe%to_Portobello, $outhwest_Burger, Cla%sic_Che%s%steak
Enter your recommendation: Cla%sic_Che%s%steak
ClaCla%sic_Che%s%steakic_Che(null)
picoCTF{7h3_cu570m3r_15_n3v3r_SEGFAULT_f89c1405}
```

Hence we solve our first challenge :D

## Flag

> picoCTF{7h3_cu570m3r_15_n3v3r_SEGFAULT_f89c1405}